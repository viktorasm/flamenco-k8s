# Taskfile.yml
version: '3'


env:
  KUBECONFIG: "{{.TASKFILE_DIR}}/deployment/infrastructure/kubeconfig"


tasks:
  build-blender-container:
    desc: "build blender container"
    dir: deployment/images/ubuntu-blender
    cmds:
      - docker build . -t flamenco-blender-base
  build-manager:
    desc: "build manager container"
    dir: deployment/images/manager
    cmds:
      - docker build . -t flamenco-manager
  build-worker:
    desc: "build worker container"
    dir: deployment/images/worker
    cmds:
      - echo "make sure network exists with  'docker network create test-network'"
      - docker build . -t flamenco-worker

  tf-apply:
    desc: "terraform apply with auto-approve"
    dir: deployment/infrastructure
    cmds:
      - terraform apply -auto-approve
  tf-destroy:
    desc: "terraform - destroy all cloud resources"
    dir: deployment/infrastructure
    cmds:
      - terraform destroy
  helm-upgrade:
    desc: "redeploy helm chart local changes"
    dir: deployment/chart
    cmds:
      - helm upgrade flamenco .
  debug-job:
    desc: "sends debug job"
    dir: scripts
    cmds:
      - ./debug-job-render.sh
    silent: true
  stop-all:
    cmds:
      - docker stop my-flamenco-manager-instance
      - docker stop flamenco-worker-instance
    silent: true